<?php /* Template Name: Facility Risk Registry */get_header();global $user_switching;$volnerabilityOptions = $threatOptions = ['1'=>'LOW', '2'=>'MED', '3'=>'HIGH'];$impactOptions = ['1'=>'VERY LOW', '2'=>'LOW', '3'=>'MODERATE', '4'=>'HIGH', '5'=>'VERY HIGH'];$permission = facilityInputController();$data = get_term_meta(advisory_get_user_company_id(), 'company_data', true);$excerptLength = 15;?><div class="content-wrapper">	<div class="page-title">        <div> <h1><img class="dashboardIcon" src="<?php echo get_template_directory_uri(); ?>/images/icon-rr.png" alt=""><?php _e('Facility Register', 'advisory'); ?> <img class="pdfIcon" src="<?php echo get_template_directory_uri(); ?>/images/icon-pdf2.png" alt=""></h1> </div>        <div> <ul class="breadcrumb"> <li><i class="fa fa-home fa-lg"></i></li> <li><a href="#"><?php _e('Facility Register', 'advisory'); ?></a></li> </ul> </div>    </div>    <?php    $company_id = advisory_get_user_company_id();	if (advisory_metrics_in_progress($company_id, array('facility'))) {		$form_id = advisory_get_active_forms($company_id, array('facility'));	} else {		$id = new WP_Query([			'post_type' 		=> 'facility',			'post_status' 		=> 'archived',			'posts_per_page' 	=> 1,			'meta_query' 		=> [['key' => 'assigned_company', 'value' => $company_id]],			'fields' 			=> 'ids',		]);		if ($id->found_posts > 0) { $form_id = $id->posts; }	}	if ( !empty($form_id) ) {		$rr_data = advisory_get_formatted_frr_data($form_id[0]);	    foreach ($rr_data as $rr) {	    	if (@$_GET['cat'] != advisory_id_from_string($rr['cat'])) { continue; }	        $base = !empty($rr['base']) ? number_format($rr['base']) * 1000 : 0;	        foreach ($rr['areas'] as $area) {	        	$base++;		        $vulnerability = (empty($area['vulnerability']) ? 0 : round(array_sum($area['vulnerability'])/count($area['vulnerability'])));		        $impact = (empty($area['impact']) ? 0 : round(array_sum($area['impact'])/count($area['impact'])));		        $threat = (empty($area['threat']) ? 0 : round(array_sum($area['threat'])/count($area['threat'])));		        $avg = empty($area['avg']) ? 0 : $area['avg'];		        $rr_id = advisory_id_from_string($area['name']) . '_frr_registry';		        $default = advisory_company_default_values(advisory_get_user_company_id(), $rr_id);		        $defaultVulnerability = !empty($default['vulnerability']) ? $default['vulnerability'] : 0; 		        $defaultImpact = !empty($default['impact']) ? $default['impact'] : 0; 		        $defaultThreat = !empty($default['threat']) ? $default['threat'] : 0; 		        $defaultAvg = $defaultVulnerability * $defaultImpact * $defaultThreat;		        $vul = !empty($area['ai']) ? ['value' => $area['ai'], 'cls' => 'active', 'count'=>count(explode(',', $area['ai']))] : ['value' => '', 'cls' => '', 'count' => 0];		        $ai = !empty($area['rw']) ? ['value' => $area['rw'], 'cls' => 'active', 'count'=>count(explode(',', $area['rw']))] : ['value' => '', 'cls' => '', 'count' => 0];		        $PUCSummary = !empty($area['c_summary']) ? $area['c_summary'] : '';		        $PUCHistoricalEvidence = !empty($area['c_historical_evidence']) ? $area['c_historical_evidence'] : '';		        echo '<div class="row" id="risk_'. $form_id[0] .'">		            <div class="col-md-12">		                <form class="form rr-form" method="post" data-meta="'. $rr_id .'" data-id="'. advisory_get_user_company_id() .'">		                    <div class="card">		                        <div class="card-title-w-btn">		                            <h4 class="title">Category: ' . $rr['cat'] . '<br> <small>' . $base . ' : ' . $area['name'] . '</small></h4>';		                            if ($permission['edit']) { echo '<button class="btn btn-success" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>'; }	                            echo '</div>		                        <div class="card-body">		                            <div class="table-responsive table-frr-registry">		                                <table class="table table-bordered table-survey mb-none">		                                    <thead>		                                        <tr>		                                            <th style="width:45%;" class="t-heading-dark text-uppercase font-110p"><strong>Risk Description</big></th>		                                            <th style="width:10%;" class="t-heading-dark text-uppercase font-110p"><strong>Assets Impacted</big></th>		                                            <th style="width:10%;" class="t-heading-dark text-uppercase font-110p"><strong>Vulnerabilities</big></th>		                                            <th style="width:23%;" class="t-heading-dark text-uppercase font-110p"><strong>Risk Owner</big></th>		                                            <th style="width:12%;" class="t-heading-dark text-uppercase font-110p"><strong>Assessment Date</big></th>		                                        </tr>		                                    </thead>		                                    <tbody>		                                        <tr>		                                            <td>'. $area['rd'] .'</td>		                                            <th class="text-center BCPRAssetsBtn '. $ai['cls'] .'" data="'. $ai['value'] .'">'. $ai['count'] .'</th>		                                            <th class="text-center BCPRvulnerabilityBtn '. $vul['cls'] .'" data="'. $vul['value'] .'">'. $vul['count'] .'</th>		                                            <td class="no-padding"><textarea style="color: #333;" name="rw" class="form-control" ' . $permission['attr'] . '>'.@$default['rw'].'</textarea></td>		                                            <td class="text-center">'. $area['lad'] .'</td>		                                        </tr>		                                    </tbody>		                                </table>		                                <table class="table table-bordered table-survey mb-none">		                                    <tbody>';		                                        echo '<tr>';		                                            echo '<th colspan="4" class="t-heading-l-dark text-uppercase text-center font-110p">Inherent Risk</th>';		                                            echo '<th colspan="2" class="t-heading-l-dark text-uppercase text-center font-110p" style="width:200px;">Analysis</th>';		                                            echo '<th colspan="3" class="t-heading-l-dark text-uppercase text-center font-110p">Controls</th>';		                                        echo '</tr>';		                                        echo '<tr>';		                                            echo '<th class="t-heading-ll-dark text-center text-uppercase font-110p">Threat</th>';		                                            echo '<th class="t-heading-ll-dark text-center text-uppercase font-110p">Vulnerability</th>';		                                            echo '<th class="t-heading-ll-dark text-center text-uppercase font-110p">&nbsp;&nbsp;&nbsp;&nbsp;Impact&nbsp;&nbsp;&nbsp;&nbsp;</th>';		                                            echo '<th class="t-heading-ll-dark text-center text-uppercase font-110p">Risk</th>';		                                            echo '<td rowspan="2" class="bcprCommentWrapper p-0">';		                                            echo '<div class="bigComment pointer" comment="'.htmlentities($PUCSummary).'"><img style="max-width:50px;margin:0 auto;" src="'. IMAGE_DIR_URL .'bcp/summary.png" class="img-responsive clickableIcon" alt="Summary" title="Summary"></div>';		                                            echo '</td>';		                                            echo '<td rowspan="2" class="bcprCommentWrapper p-0">';		                                            echo '<div class="bigComment pointer" comment="'.htmlentities($PUCHistoricalEvidence).'"><img style="max-width:50px;margin:0 auto;" src="'. IMAGE_DIR_URL .'bcp/historical_evidence.png" class="img-responsive clickableIcon" alt="Historical Evidence" title="Historical Evidence"></div>';		                                            echo '</td>';		                                            echo '<td rowspan="3" colspan="3" class="no-padding width-65p">';		                                                echo '<textarea name="controls" rows="4" class="form-control" ' . $permission['attr'] . '>'.@$default['controls'].'</textarea>';		                                            echo '</td>';		                                        echo '</tr>';		                                        echo '<tr>';		                                            echo '<td class="no-paddding angleContainer font-110p '. facilityBackgroundByValue($threat, 'threat') .'"><div class="angularArea risk"></div> ' . $threatOptions[$threat] .'</td>';		                                            echo '<td class="no-paddding angleContainer font-110p '. facilityBackgroundByValue($vulnerability, 'vulnerability') .'"> <div class="angularArea risk"></div>' . $volnerabilityOptions[$vulnerability] .'</td>';		                                            echo '<td class="no-paddding angleContainer font-110p '. facilityBackgroundByValue($impact, 'impact') .'"> <div class="angularArea risk"></div>' . $impactOptions[$impact] .'</td>';		                                            echo '<td class="text-center no-paddding font-110p ' . facilityRiskBackground($avg) . '">' . @$avg . '</td>';		                                        echo '</tr>		                                    </tbody>		                                </table>		                                <table class="table table-bordered table-survey">		                                	<tbody>		                                        <tr>		                                            <th colspan="2" class="t-heading-l-dark text-uppercase text-center font-110p">Proposed Risk Treatment</th>		                                            <th colspan="3" class="t-heading-l-dark text-uppercase text-center font-110p">Residual Risk</th>		                                            <th class="t-heading-l-dark text-uppercase font-110p">Notes</th>		                                        </tr>		                                        <tr>		                                            <th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width:100px;">Avoid</th>		                                            <td class="no-padding"><input type="text" name="avoid" class="form-control boldText no-border" ' . $permission['attr'] . ' value="'.@$default['avoid'].'"></td>		                                            <th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width: 110px; padding: 0;">Threat</th>		                                            <th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width: 125px; padding: 0;">Vulnerability</th>		                                            <th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width: 125px; padding: 0;">Impact</th>		                                            <td rowspan="4" class="no-padding"><textarea name="notes" rows="6" class="form-control" ' . $permission['attr'] . '>'.@$default['notes'].'</textarea></td>		                                        </tr>		                                        <tr>		                                            <th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width:100px;">Mitigate</th>		                                            <td class="no-padding"><input type="text" name="mitigate" class="form-control boldText no-border" ' . $permission['attr'] . ' value="'.@$default['mitigate'].'"></td>		                                            <td rowspan="2" data-type="threat" class="no-padding angleContainer font-110p '.facilityBackgroundByValue($defaultThreat, 'threat').'"><div class="angularArea"></div>' . advisory_opt_select('threat', '', '', $permission['attr'], $threatOptions, $defaultThreat) . '</td>		                                            <td rowspan="2" data-type="vulnerability" class="no-padding angleContainer font-110p '.facilityBackgroundByValue($defaultVulnerability, 'vulnerability').'"><div class="angularArea"></div>' . advisory_opt_select('vulnerability', '', '', $permission['attr'], $volnerabilityOptions, $defaultVulnerability) . '</td>													<td rowspan="2" data-type="impact" class="no-padding angleContainer font-110p '.facilityBackgroundByValue($defaultImpact, 'impact').'"><div class="angularArea"></div>' . advisory_opt_select('impact', '', '', $permission['attr'], $impactOptions, $defaultImpact) . '</td>		                                        </tr>		                                        <tr>		                                        	<th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width:100px;">Accept</th>		                                        	<td class="no-padding"><input type="text" name="accept" class="form-control boldText no-border" ' . $permission['attr'] . ' value="'.@$default['accept'].'"></td>		                                        </tr>		                                        <tr>		                                        	<th class="t-heading-ll-dark text-center text-uppercase font-110p" style="width:100px;">Transfer</th>		                                        	<td class="no-padding"><input type="text" name="transfer" class="form-control boldText no-border" ' . $permission['attr'] . ' value="'.@$default['transfer'].'"></td>		                                        	<th class="t-heading-ll-dark text-center text-uppercase font-110p">TARGET</th>		                                        	<td class="no-padding frrAvg '.facilityRiskBackground($defaultAvg).'" colspan="2">&nbsp;</td>		                                        </tr>		                                    </tbody>		                                </table>		                            </div>		                        </div>		                    </div>		                </form>		            </div>		        </div>';	        }	    }	} else {		echo '<p>' . __('Facility Register Not Available Yet') . '</p>';	} ?></div><div class="modal fade" id="BCPRModal">    <div class="modal-dialog modal-lg">        <div class="modal-content modal-inverse" style="background: #000000bf;">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Select options</h4>            </div>            <div class="modal-body"> </div>            <div class="modal-footer"> <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> </div>        </div>    </div></div><div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModal">    <div class="modal-dialog modal-lg" role="document">        <div class="modal-content">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                <h4 class="modal-title" id="helpModal">Asset & Vulnerability Definitions</h4>            </div>            <div class="modal-body">                <iframe width="100%" height="600" src="<?php echo get_template_directory_uri() .'/images/pdf/Asset_and_Vulnerability_Codes.pdf' ?>"></iframe>            </div>            <div class="modal-footer">                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>            </div>        </div>    </div></div><div class="modal fade" id="bigCommentModal">    <div class="modal-dialog modal-lg">        <div class="modal-content modal-inverse">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Comment</h4>            </div>            <div class="modal-body" style="font-size: 16px;"></div>            <div class="modal-footer"> <button type="button" class="btn btn-default" data-dismiss="modal">Close</button> </div>        </div>    </div></div><script>jQuery(function($) {	"use strict"	$(document).on('click', '.pdfIcon', function(event) {	    event.preventDefault();	    $('#helpModal').modal('show');	});	$(document).on('click', '.bigComment', function(event) {	    event.preventDefault();	    var comment = $(this);	    var text = comment.attr('comment');	    var modal = $('#bigCommentModal');	    modal.find('.modal-body').html(text);	    modal.modal('show');	});	$('#bigCommentModal').on('hide.bs.modal', function() {	    $(this).find('.modal-body').html('');	});	// SELECT OPTIONS	$('.table-frr-registry select').on('change', function(e) {		e.preventDefault()        facilityCalculation(jQuery(this), true);        facility_calc_avg();	})	function facilityCalculation(element, register=false) {        var data = {}        var reverse = element.hasClass('reverse')        var increment = element.hasClass('increment')        var val = element.val()        var type = element.parent('td').attr('data-type');        if (reverse) { val = String(Number(val) + 1) }        if (increment && val == '0') { val = String(Number(val) + 1) }        element.parent('td').removeClass('bg-red bg-orange bg-yellow bg-green bg-blue').addClass(facilityBackgroundByValue(val, type))        element.parents('tr').find('select').each(function(i, e) {            var val = Number(jQuery(this).val())            data[i] = val        })        var calc = facilityRiskCalculation(data);        if (register) element.parents('table').find('.frrAvg').removeClass('bg-red bg-orange bg-yellow bg-green bg-blue').addClass(calc.cls);        else element.parents('tr').find('.facility').html(calc.count).parent('td').removeClass().addClass('text-center ' + calc.cls);    }    function facilityBackgroundByValue(val, type='impact', reverse=false) {        let cl = 'color-blue';        if ( val && type ) {            if ( type == 'impact' ) {                switch (val) {                    case '1': cl = 'bg-blue'; break;                    case '2': cl = 'bg-green'; break;                    case '3': cl = 'bg-yellow'; break;                    case '4': cl = 'bg-orange'; break;                    case '5': cl = 'bg-red'; break;                    default:  cl = 'color-blue'; break;                }            } else if ( type == 'vulnerability' || type == 'threat' ) {                switch (val) {                    case '1': cl = 'bg-blue'; break;                    case '2': cl = 'bg-yellow'; break;                    case '3': cl = 'bg-red'; break;                    default:  cl = 'color-blue'; break;                }            }         }        return cl    }    function facilityRiskCalculation(obj) {        var data = {count:1, avg:1};        data.count = Number(obj[0]) * Number(obj[1]) * Number(obj[2]);        if (data.count > 1) data.avg = Number(data.count / 3).toFixed(1);        else data.count = 1;        if ( data.count >= 30 )      { data.cls = 'bg-red'; }         else if ( data.count >= 20 ) { data.cls = 'bg-orange'; }         else if (data.count >= 11 )  { data.cls = 'bg-yellow'; }         else if (data.count >= 2 )   { data.cls = 'bg-green'; }         else                         { data.cls = 'bg-blue'; }        return data    }    function facility_calc_avg() {        jQuery('.table-frr-registry').each(function() {            var count = 0            var total = 0            var color            var level            var card = jQuery(this).parents('.card');            jQuery(this).find('.facility').each(function() {                count += 1                total += Number(jQuery(this).html())            })            var avg = Math.round(total / count).toFixed(1)            if (isNaN(avg)) { avg = (1).toFixed(1); }            if ( avg >= 30 )      { color = 'bg-red'; level = 'Very High'; }             else if ( avg >= 20 ) { color = 'bg-orange'; level = 'High'; }             else if (avg >= 11 )  { color = 'bg-yellow'; level = 'Moderate'; }             else if (avg >= 2 )   { color = 'bg-green'; level = 'Low'; }             else                  { color = 'bg-blue'; level = 'Very Low'; }            card.find('.avgContainer').removeClass('bg-red bg-orange bg-yellow bg-green bg-blue').addClass(color);            card.find('.total-bcp').find('strong').html(level)            card.find('.total-facility-avg').find('span').html(avg)            card.find('.threatAvg').val(avg)        })    }});</script><?php get_footer(); ?>